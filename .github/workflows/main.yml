name: Deploy Laravel Project

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===============================
      # 1Ô∏è‚É£ Upload files to server
      # ===============================
      - name: Upload files via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}   # deployer
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          source: "."
          target: "/var/www/travel-demo"
          overwrite: true

      # ===============================
      # 2Ô∏è‚É£ Server-side setup & Laravel commands
      # ===============================
      - name: Run SSH commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            set -e

            cd /var/www/travel-demo

            echo "üìÅ Ensure required directories exist"
            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p bootstrap/cache

            echo "üîê Ensure correct permissions (ACL-based setup)"
            chmod -R 775 storage bootstrap/cache

            # -------------------------------------------------
            # ‚ö†Ô∏è ONE-TIME ONLY (COMMENTED)
            # Run manually once if ACL not applied yet
            # -------------------------------------------------
            # sudo chown -R deployer:deployer /var/www/travel-demo
            #
            # sudo setfacl -R -m u:deployer:rwx /var/www/travel-demo
            # sudo setfacl -R -m u:www-data:rx /var/www/travel-demo
            #
            # sudo setfacl -R -m u:www-data:rwx storage bootstrap/cache
            #
            # sudo setfacl -R -d -m u:deployer:rwx /var/www/travel-demo
            # sudo setfacl -R -d -m u:www-data:rx /var/www/travel-demo
            # sudo setfacl -R -d -m u:www-data:rwx storage bootstrap/cache
            # -------------------------------------------------

            echo "üì¶ Install composer dependencies"
            composer install \
              --no-dev \
              --optimize-autoloader \
              --no-interaction \
              --prefer-dist

            echo "‚öôÔ∏è Laravel optimizations"
            if [ -f .env ]; then
              php artisan key:generate --force || true
              php artisan config:clear
              php artisan route:clear
              php artisan view:clear

              php artisan config:cache
              php artisan route:cache
              php artisan view:cache

              # php artisan migrate --force
            else
              echo "‚ö†Ô∏è .env not found ‚Äî skipping artisan commands"
            fi

            echo "‚úÖ Deployment completed successfully"
