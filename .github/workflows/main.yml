name: Deploy Laravel Project

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Pre-deployment Cleanup (Smart Clean)
      - name: Pre-deployment Cleanup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            cd /var/www/travel-demo/
            # .env, storage, aur bootstrap/cache ko chor kar baaki sab delete karein
            # Isse 'Permission Denied' nahi aayega kyunki storage touch hi nahi hogi
            find . -maxdepth 1 ! -name '.env' ! -name 'storage' ! -name 'bootstrap' ! -name '.' -exec rm -rf {} +

      # 2. Files upload karna
      - name: Copy files via SFTP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          source: "."
          target: "/var/www/travel-demo/"
          # Is baar storage upload nahi karenge taake purani permissions na hilen
          # Agar aapka local storage khali hai to ye behtar hai
          strip_components: 0

      # 3. Final Setup
      - name: Execute SSH commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            cd /var/www/travel-demo/
            
            # Composer and Artisan (Safe Mode)
            composer install --no-dev --no-interaction --no-scripts --optimize-autoloader
            
            if [ -f .env ]; then
                php artisan config:clear
                php artisan route:clear
                php artisan view:clear
                php artisan cache:clear
                # Logs folder fix (ACL will handle the rest)
                touch storage/logs/laravel.log
                chmod 666 storage/logs/laravel.log
                echo "Deployment Successful with ACL!"
            fi
