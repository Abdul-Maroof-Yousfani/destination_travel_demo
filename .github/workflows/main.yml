name: Deploy Laravel Project (Fast Rsync)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===============================
      # 1Ô∏è‚É£ Rsync deploy (FAST)
      # ===============================
      - name: Deploy via rsync
        uses: burnett01/rsync-deployments@v4
        with:
          switches: -avz --delete
          path: ./
          remote_path: /var/www/travel-demo/
          remote_host: ${{ secrets.SFTP_HOST }}
          remote_user: ${{ secrets.SFTP_USER }}   # deployer
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ===============================
      # 2Ô∏è‚É£ Server-side Laravel setup
      # ===============================
      - name: Run SSH commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            cd /var/www/travel-demo

            echo "üìÅ Ensure required directories"
            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p bootstrap/cache

            echo "üîê Permissions (ACL-friendly)"
            chmod -R 775 storage bootstrap/cache

            echo "üì¶ Composer install"
            composer install \
              --no-dev \
              --prefer-dist \
              --optimize-autoloader \
              --no-interaction

            echo "‚öôÔ∏è Laravel optimize"
            if [ -f .env ]; then
              php artisan config:clear
              php artisan route:clear
              php artisan view:clear

              php artisan config:cache
              php artisan route:cache
              php artisan view:cache
              # php artisan migrate --force
            else
              echo "‚ö†Ô∏è .env not found ‚Äî skipping artisan"
            fi

            echo "‚úÖ Deploy finished"
