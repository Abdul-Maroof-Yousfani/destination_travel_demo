name: Deploy Laravel Project

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Pre-deployment Cleanup (Smart Clean)
      - name: Pre-deployment Cleanup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            cd /var/www/travel-demo/
            # Storage aur Bootstrap ko touch kiye baghair baaki sab saaf
            find . -maxdepth 1 ! -name '.env' ! -name 'storage' ! -name 'bootstrap' ! -name '.htaccess' ! -name '.' -exec rm -rf {} +

      # 2. Files upload karna (Ignoring storage & bootstrap)
      - name: Copy files via SFTP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          source: "*, !storage, !bootstrap" # <--- Yahan magic hai, in folders ko skip kar do
          target: "/var/www/travel-demo/"
          strip_components: 0

      # 3. Final Setup
      - name: Execute SSH commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            cd /var/www/travel-demo/
            
            # Folders ensure karein (agar nahi hain to)
            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p storage/logs
            mkdir -p bootstrap/cache
            
            # Laravel Setup
            composer install --no-dev --no-interaction --no-scripts --optimize-autoloader
            
            if [ -f .env ]; then
                php artisan config:clear
                php artisan route:clear
                php artisan view:clear
                php artisan cache:clear
                echo "Deployment Successful! Storage was not touched by SCP."
            fi
