name: Deploy Laravel Project

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Purani files cleanup (taake permissions/utime ka masla na aaye)
      - name: Pre-deployment Cleanup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            mkdir -p /var/www/travel-demo/
            cd /var/www/travel-demo/
            # .env file ko chor kar baaki sab delete karein fresh copy ke liye
            find . -maxdepth 1 ! -name '.env' ! -name '.' -exec rm -rf {} +

      # 2. Nayi files upload karna
      - name: Copy files via SFTP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          source: "."
          target: "/var/www/travel-demo/"
          strip_components: 0

      # 3. Permissions aur Safe Laravel Setup
      - name: Execute SSH commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          password: ${{ secrets.SFTP_PASS }}
          port: 22
          script: |
            cd /var/www/travel-demo/
            
            # Directory structure create karna
            mkdir -p storage/framework/{sessions,views,cache}
            mkdir -p bootstrap/cache
            
            # Permissions set karna
            chmod -R 775 storage bootstrap/cache
            
            # Composer: --no-scripts use kiya hai taake PSR-4 errors pipeline na rokain
            composer install --no-dev --no-interaction --no-scripts --optimize-autoloader
            
            # Laravel Safe Commands
            if [ -f .env ]; then
                # Caching ke bajaye sirf purana kachra saaf (Clear) kar rahe hain
                # Taake Missing Component [hotels] wala error na aaye
                php artisan config:clear
                php artisan route:clear
                php artisan view:clear
                php artisan cache:clear
                
                echo "Deployment successfully completed in safe mode."
            else
                echo ".env file not found, skipping artisan commands"
            fi
